<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./jquery-mobile-theme-073121-0/themes/t11jobswatch.css">
  <link rel="stylesheet" href="./jquery-mobile-theme-073121-0/themes/jquery.mobile.icons.min.css">
  <!-- <link rel="stylesheet" href="./commadelimited-jQuery-Mobile-Icon-Pack/dist/jqm-icon-pack-fa.css" /> -->
  <!-- <link rel="stylesheet" href="./jquery/jquery.mobile-1.4.5.css"> -->
  <link rel="stylesheet" href="./jquery/jquery.mobile.structure-1.4.5.css">
  <link rel="shortcut icon" href="./jquery/demos/favicon.ico">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
  <script src="./jquery/demos/js/jquery.js"></script>
  <!-- <script src="./jquery/demos/_assets/js/index.js"></script> -->
  <script>
    $(document).one("mobileinit", function () {
      $.mobile.defaultPageTransition = "slide"
    })
  </script>
  <script src="./jquery/jquery.mobile-1.4.5.min.js"></script>
  <script src="./js/main.js"></script>
  <!-- <script src="./js/bundle.js"></script> -->
  <style>
    /* Adjust the vertical three dots of this icon centered */
    .ui-icon-ellipsis-v:after {
      background-image: url("commadelimited-jQuery-Mobile-Icon-Pack/dist/png/ellipsis-v.png");
      background-repeat: no-repeat;
      /* background-position: 9px 3px; */
      background-position-x: 9px;
    }
  </style>
  <title>Job Watch</title>
</head>

<body>
  <!-- CONFIG -->
  <section data-role="page" id="configPage" data-theme="b">
    <div data-role="panel" data-position="right" id="configErrorPanel">
      <p id="configErrorDisplayText">Cannot Connect to Server</p>
      <a href="#configPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Config</h1>
    </header>
    <main class="ui-content">
      <div class="ui-grid-solo">
        <div class="ui-block-a">
          <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true" style="text-align: center;">
            <input type="radio" name="http" id="httpInputRadio" value="http" checked="checked">
            <label for="httpInputRadio">HTTP</label>
            <input type="radio" name="http" id="httpsInputRadio" value="https">
            <label for="httpsInputRadio">HTTPS</label>
          </fieldset>
        </div>
        <div class="ui-block-a">
          <input id="hostNameInputText" placeholder="julika.villo.io" type="text" data-clear-btn="true" name="hostNameInputText"
            value="MIKISURFACE" style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <div class="ui-grid-a">
            <div class="ui-block-a">
              <input id="serviceNameInputText" placeholder="api" type="text" data-clear-btn="true" name="serviceNameInputText"
                value="t11sqlbroker" style="text-align: center;">
            </div>
            <div class="ui-block-b">
              <input id="portInputNumber" placeholder="99999" type="number" step="1" data-clear-btn="true" name="portInputNumber"
                pattern="[0-9]*" value="80" style="text-align: center;">
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Exit</a>
        <a id="doneButton" href="#loginPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-home ui-btn-b">Done</a>
        <a href="#" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      //console.log("Reloaded on " + Date.now())
      //pageinit event is only JQuery event
      $(document).one("pageinit", async e => {
        if(e.target.id === "configPage") {
          doneButton.addEventListener("click", async e => {
            e.preventDefault()
            saveServiceURLToLocalStore(httpInputRadio.checked,hostNameInputText.value,portInputNumber.value,serviceNameInputText.value)
            try {
              // let response = await SQLBroker("select top 1 ItemCode from OITM")
              let response = await userQuery("TestConnection")
              //console.log(response.data[0].ItemCode)
              //configErrorDisplayText.textContent = response.data[0].ItemCode
              $.mobile.changePage("#loginPage")
            } catch(error) {
              const msg = textFrom(error)
              configErrorDisplayText.textContent = msg ? msg : "Empty"
              $("#configErrorPanel").panel("open")
              console.log(error);
            }
          })
        }
      })
    </script>
  </section>

  <!-- LOGIN -->
  <section data-role="page" id="loginPage" data-theme="b">
    <div data-role="panel" data-position="right" id="loginErrorPanel">
      <p id="loginErrorDisplayText">Invalid user name or PIN</p>
      <a href="#loginPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Login</h1>
    </header>
    <main role="main" class="ui-content">
      <div class="ui-grid-solo">
        <div class="ui-block-a">
          <input placeholder="user" type="text" data-clear-btn="true" name="userCodeInputText" id="userCodeInputText" value="merlina"
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <input placeholder="1234" type="number" data-clear-btn="true" name="pinInoutNumber" pattern="[0-9]*" id="pinInputNumber" step="1"
            value="" style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <div class="ui-grid-a">
            <div class="ui-block-a">
              <p style="text-align: end; margin-right: 16px;">Auto-Login:</p>
            </div>
            <div class="ui-block-b">
              <select name="slider-flip-m" id="slider-flip-m" data-role="slider" data-mini="true">
                <option value="off">No</option>
                <option value="on" selected="">Yes</option>
              </select>
            </div>
          </div>
        </div>
        <div class="ui-block-a">
          <h2 id="loginUserNameDisplayText" style="text-align: center;"></h2>
        </div>
      </div>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#configPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Config</a>
        <a id="loginButton" href="#resourcesPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Login</a>
        <a href="#loginErrorPanel"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      $(document).on("pageinit", async e => {
        if(e.target.id === "loginPage") {
          loginButton.addEventListener("click", async e => {
            e.preventDefault()
            try {
              // let response = await SQLBroker(
              //   `select Code,e.userId,lastName,firstName 
              //   from OHEM e left outer join OUSR u on e.userId = u.USERID  
              //   where u.USER_CODE = '${user.value}' 
              //   -- or Code = '${user.value}'`)
              let response = await userQuery("QueryEmployeeByUserCode",userCodeInputText.value)
              if(response.data.length) {
                saveUserToLocalStore(response.data[0])
                loginUserNameDisplayText.textContent = "Hello " + response.data[0].lastName + ", " + response.data[0].firstName 
                await sleepAsync(2000)
                $.mobile.changePage("#resourcesPage")
              } else {
                loginErrorDisplayText.textContent = `Invalid user code ${userCodeInputText.value}`
                $("#loginErrorPanel").panel("open")
              }
            } catch(error) {
                loginErrorDisplayText.textContent = error.responseJSON.errorText
                $("#loginErrorPanel").panel("open")
                console.log(error);
              }
            }
          )
        }
      })
    </script>
  </section>

  <!-- RESOURCES -->
  <section data-role="page" id="resourcesPage" data-theme="b">
    <div data-role="panel" data-position="right" id="resourcesErrorPanel">
      <p id="resourcesErrorDisplayText">Some Problem</p>
      <a href="#resourcesPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Resources</h1>
    </header>
    <main role="main" class="ui-content">
      <ul id="resourcesListView"
        data-role="listview" data-count-theme="b" data-filter="true" data-filter-placeholder="Search ..."
        data-inset="true">
        <li data-icon="gear"><a href="#startJobPage">Cracker Painter<span class="ui-li-count">98</span></a></li>
        <li data-icon="gear"><a href="#startJobPage">Giga Crane BX5<span class="ui-li-count">41</span></a></li>
        <li data-icon="user"><a href="#startJobPage">Packagers<span class="ui-li-count">4</span></a></li>
        <li data-icon="user"><a href="#startJobPage">MC SEtup Specialist<span class="ui-li-count">12</span></a></li>
        <li data-icon="star"><a href="#startJobPage">Red Big Hammers <span class="ui-li-count">328</span></a></li>
        <li data-icon="star"><a href="#startJobPage">Trash Can Hanger <span class="ui-li-count">62</span></a></li>
      </ul>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#loginPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Logout</a>
        <a href="#startJobPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Jobs</a>
        <a href="#resourcesErrorPanel"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      async function queryAndShowResourcesAsync() {
        const userDetails = getUserDetailsFromLocalStore()
        try {
          const response = await userQuery("QueryResourcesForUser",userDetails.USER_CODE)
          const htmlText = response.data.reduce((a,r)=> a += `
          <li data-icon="${resIcon(r.ResType)}">
            <a href="#startJobPage" data-rescode="${r.ResCode}">${r.ResName}<span class="ui-li-count">${r.OpenJobs}</span></a>
          </li>`,"")
          $("#resourcesListView").html(htmlText).listview("refresh")
        } catch(error) {
          resourcesErrorDisplayText.textContent = textFrom(error)
          $("#resourcesErrorPanel").panel("open")
        }
      }
      $(document).on("pagebeforeshow", e => {
        if(e.target.id === "resourcesPage") {
          queryAndShowResourcesAsync() // No need to call this here with await
        }        
      })
      $(document).on("pageinit", async e => {
        if(e.target.id === "resourcesPage") {
          $("#resourcesListView").click(e => {
            //e.preventDefault()
            //resourcesErrorDisplayText.textContent = e.target.dataset.rescode
            //$("#resourcesErrorPanel").panel("open")
            saveResCodeToLocalStore(e.target.dataset.rescode)
          })
        }
      })
    </script>
  </section>

  <!-- START JOB -->
  <section data-role="page" id="startJobPage" data-theme="b">
    <div data-role="panel" data-position="right" id="startJobErrorPanel">
      <p id="startJobErrorDisplayText">No jobs to start</p>
      <a href="#startJobPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Jobs</h1>
      <a href="#resourcesPage" data-icon="gear">Res</a>
    </header>
    <main role="main" class="ui-content">
      <ul id="openJobsListView"
        data-role="listview" data-filter="true" data-filter-placeholder="Search ..." data-inset="true">
        <li data-role="list-divider">10/8/2020 Morning Shift<span class="ui-li-count">2</span></li>
        <li data-icon="gear">
          <a href="#runningjob">
            <h2>Dry Hanging</h2><span class="ui-li-count">4500</span>
            <p><strong>Red Bike BXP 75</strong></p>
            <p class="ui-li-aside"><strong>35478-12 (6:24)</strong></p>
          </a>
        </li>
        <li data-icon="gear">
          <a href="#">
            <h2>Dry Hanging (Rework)</h2><span class="ui-li-count">23700.5</span>
            <p><strong>Boston Conference Fork</strong></p>
            <p class="ui-li-aside"><strong>35611-1 (9:18)</strong></p>     
          </a>
        </li data-icon="gear">
        <li data-role="list-divider">10/8/2020 Night Shift<span class="ui-li-count">1</span></li>
        <li data-icon="gear">
          <a href="#">
            <h2>Avery Walking</h2><span class="ui-li-count">50550</span>
            <p><strong>Dinner Tonight Kit BX 567</strong></p>
            <p class="ui-li-aside"><strong>35534-8 19:48</strong></p>
          </a>
        </li>
      </ul>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#resourcesPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Resource</a>
        <a href="#runningjob" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Start</a>
        <a href="#loginPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Logout</a>
        <a href="#startJobErrorPanel"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-forbidden ui-btn-b">Hmm</a>
      </div>
    </footer>
    <script>
      function showOpenJobsToStart(data) {
        let runningDate = null
        const htmlText = data.reduce((a,r)=> {
          if(r.EffStartDate != runningDate) {
            runningDate = r.EffStartDate
            a += `
              <li data-role="list-divider">${formatDate(runningDate)}
                <span class="ui-li-count">${formatTime(r.BeginTime)}</span>
              </li>
            `    
          }
          a += `
              <li data-icon="${resIcon(r.ResType)}">
                <a href="#runningjob">
                  <h2>${r.Name}</h2><span class="ui-li-count">${parseFloat(r.OpenQty)}</span>
                  <p><strong>${r.ProdName}</strong></p>
                  <p class="ui-li-aside"><strong>${r.DocNum}-${r.VisOrder + 1} (${formatTime(r.BeginTime)})</strong></p>
                </a>
              </li>
              `
          return a
        },"")
        $("#openJobsListView").html(htmlText).listview("refresh")
      }
      function queryOpenJobsToStartForUserAndResource() {
        const userDetails = getUserDetailsFromLocalStore()
        const resCode = getResCodeFromLocalStore()
        const url = encodeURI(uq() + `QueryOpenJobsToStartForUserAndResource?p0=${resCode}`)
        console.log(url)
        showLoadingIndicator()
        // $.ajax({url,method:"GET"}).done(sqlResult => {
        //   console.log(sqlResult)
        //   if(sqlResult.errorCode == 0) {
        //     showOpenJobsToStart(sqlResult.data)
        //   } else {
        //     // startJobErrorDisplayText.textContent = sqlResult.errorText
        //     // $("#startJobErrorPanel").panel("open")
        //   } 
        // }).fail((jxhr,status)=>{
        //   console.log(jxhr)
        //   startJobErrorDisplayText.textContent = jxhr.responseJSON.errorText
        //   $("#startJobErrorPanel").panel("open")
        // }).always(hideLoadingIndicator)
        
        fetch(url).then(r => r.json()).then(async sqlResult => {
          console.log(sqlResult)
          if(sqlResult.errorCode == 0) {
            // await sleepAsync(2000)
            showOpenJobsToStart(sqlResult.data)
          } else {
            await sleepAsync(500)
            startJobErrorDisplayText.textContent = sqlResult.errorText
            $("#startJobErrorPanel").panel("open")
          }
        }).finally(hideLoadingIndicator)
      }
      $(document).on("pagebeforeshow", async e => {
        if(e.target.id === "startJobPage") {
          queryOpenJobsToStartForUserAndResource()
        }        
      })

    </script>
  </section>

  <!-- RUNNING JOB -->
  <div data-role="page" id="runningjob" data-theme="b">
    <div data-role="header">
      <h1>Running Job</h1>
    </div>
    <div role="main" class="ui-content">
      <div class="ui-grid-a">
        <div class="ui-block-a">
          <h2>Dry Hanging</h2><strong>[4500]</strong>
          <p><strong>Red Bike BXP 75</strong></p>
          <p class="ui-li-aside"><strong>35478-12 (6:24)</strong></p>
        </div>
        <div class="ui-block-b">
          <div class="ui-grid-solo">
            <div class="ui-block-a">
              <h2>Started</h2>
              <h2 id="starttime">08:05:23</h2>
            </div>
            <div class="ui-block-a">
              <h2>Running</h2>
              <h2 id="runningtime">02:15:52</h2>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#loginPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Logout</a>
        <a href="#completedquantities"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Stop</a>
        <a href="#" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </div>
  </div>

  <!-- COMPLETED QUANTITIES -->
  <div data-role="page" id="completedquantities" data-theme="b">
    <div data-role="panel" data-position="right" id="completedquantities_error">
      <h2>Invalid rejected quantity</h2>
      <a href="#completedquantities" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back"
        data-rel="close">Close</a>
    </div><!-- /panel -->
    <div data-role="header">
      <!-- /header -->
      <h1>Quantities</h1>
    </div>
    <div role="main" class="ui-content">
      <div class="ui-grid-a">
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Completed Qty:</p>
        </div>
        <div class="ui-block-b">
          <input placeholder="56000" type="number" data-clear-btn="true" id="completedqty" step="1" value=""
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Rework Qty:</p>
        </div>
        <div class="ui-block-b">
          <input placeholder="100" type="number" data-clear-btn="true" id="reworkqty" step="1" value=""
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Rejected Qty:</p>
        </div>
        <div class="ui-block-b">
          <div class="ui-grid-a">
            <div class="ui-block-a">
              <input placeholder="0" type="number" id="rejectedqty" step="1" value=""
                style="text-align: center;"> <!-- data-clear-btn="true" -->
            </div>
            <div class="ui-block-b">
              <input placeholder="0" type="number" data-clear-btn="true" id="rejqtydec" step="1" value=""
                style="text-align: center;">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#runningjob" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Cancel</a>
        <a href="#resourcesPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-home ui-btn-b">Done</a>
        <a href="#completedquantities_error"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </div><!-- /footer -->
  </div><!-- /page -->

</body>

</html>