<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./jquery-mobile-theme-073121-0/themes/t11jobswatch.css">
  <link rel="stylesheet" href="./jquery-mobile-theme-073121-0/themes/jquery.mobile.icons.min.css">
  <!-- <link rel="stylesheet" href="./commadelimited-jQuery-Mobile-Icon-Pack/dist/jqm-icon-pack-fa.css" /> -->
  <!-- <link rel="stylesheet" href="./jquery/jquery.mobile-1.4.5.css"> -->
  <link rel="stylesheet" href="./jquery/jquery.mobile.structure-1.4.5.css">
  <link rel="shortcut icon" href="./jquery/demos/favicon.ico">
  <!-- <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700"> -->
  <script src="./jquery/demos/js/jquery.js"></script>
  <!-- <script src="./jquery/demos/_assets/js/index.js"></script> -->
  <script>
    $(document).one("mobileinit", function () {
      $.mobile.defaultPageTransition = "slide"
    })
  </script>
  <script src="./jquery/jquery.mobile-1.4.5.min.js"></script>
  <script src="./js/main.js"></script>
  <!-- <script src="./js/bundle.js"></script> -->
  <style>
    /* Adjust the vertical three dots of this icon centered */
    .ui-icon-ellipsis-v:after {
      background-image: url("commadelimited-jQuery-Mobile-Icon-Pack/dist/png/ellipsis-v.png");
      background-repeat: no-repeat;
      /* background-position: 9px 3px; */
      background-position-x: 9px;
    }
  </style>
  <title>Job Watch</title>
</head>

<body>
  <!-- CONFIG -->
  <section data-role="page" id="configPage" data-theme="b">
    <div data-role="panel" data-position="right" id="configErrorPanel">
      <p id="configErrorDisplayText">Cannot Connect to Server</p>
      <a href="#configPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Config</h1>
    </header>
    <main class="ui-content">
      <div class="ui-grid-solo">
        <div class="ui-block-a">
          <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true" style="text-align: center;">
            <input type="radio" name="http" id="httpInputRadio" value="http" checked="checked">
            <label for="httpInputRadio">HTTP</label>
            <input type="radio" name="http" id="httpsInputRadio" value="https">
            <label for="httpsInputRadio">HTTPS</label>
          </fieldset>
        </div>
        <div class="ui-block-a">
          <input id="hostNameInputText" placeholder="julika.villo.io" type="text" data-clear-btn="true" name="hostNameInputText"
            value="MIKISURFACE" style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <div class="ui-grid-a">
            <div class="ui-block-a">
              <input id="serviceNameInputText" placeholder="api" type="text" data-clear-btn="true" name="serviceNameInputText"
                value="t11sqlbroker" style="text-align: center;">
            </div>
            <div class="ui-block-b">
              <input id="portInputNumber" placeholder="99999" type="number" step="1" data-clear-btn="true" name="portInputNumber"
                pattern="[0-9]*" value="80" style="text-align: center;">
            </div>
          </div>
        </div>
        <div class="ui-block-a">
          <p style="text-align: center;">1.0.2 (20200511)</p>
        </div>
      </div>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Exit</a>
        <a id="configDoneButton" href="#loginPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-home ui-btn-b">Done</a>
        <a id="configMoreButton" href="#" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      function showConfigError(text) {
        configErrorDisplayText.textContent = text ? text : "No Error"
        $("#configErrorPanel").panel("open")
      }
      //console.log("Reloaded on " + Date.now())
      //pageinit event is only JQuery event
      $(document).one("pageinit", e => {
        if(e.target.id === "configPage") {
          configDoneButton.addEventListener("click", e => {
            e.preventDefault()
            saveServiceURLToLocalStore(httpInputRadio.checked,hostNameInputText.value,portInputNumber.value,serviceNameInputText.value)
            sqlBrokerUQ(null,"TestConnection",null,function(sqlResult){
              $.mobile.changePage("#loginPage")
            }, showConfigError,globalTimeout())
          })
          $("#configMoreButton").click(function(e) {
            e.preventDefault()
            saveServiceURLToLocalStore(httpInputRadio.checked,hostNameInputText.value,portInputNumber.value,serviceNameInputText.value)
            getProductionOrderSQL()
            //getProductionOrderBO()
          })
          function getProductionOrderSQL() {
            sqlBrokerSQL(null,`select l.*
              -- w.DocEntry, w.DocNum, l.LineNum, l.VisOrder, l.StageId, l.ItemCode 
              from OWOR w join WOR1 l on l.DocEntry = w.DocEntry 
              where w.DocEntry = 162`,function(sqlResult) {
                if(sqlResult.data && sqlResult.data.length > 0) {
                  showConfigError("Production Order received")
                }
              }, showConfigError,globalTimeout())
          }
          function getProductionOrderBO() {
            sqlBrokerGetBO(null,"ProductionOrders",162,function(boResult) {
                if(boResult.bo) {
                  showConfigError("Production Order received")
                }
              }, showConfigError,globalTimeout())
          }
        }
      })
    </script>
  </section>

  <!-- LOGIN -->
  <section data-role="page" id="loginPage" data-theme="b">
    <div data-role="panel" data-position="right" id="loginErrorPanel">
      <p id="loginErrorDisplayText">Invalid user name or PIN</p>
      <a href="#loginPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Login</h1>
    </header>
    <main role="main" class="ui-content">
      <div class="ui-grid-solo">
        <div class="ui-block-a">
          <input placeholder="user" type="text" data-clear-btn="true" name="userCodeInputText" id="userCodeInputText" value="maria"
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <input placeholder="1234" type="number" data-clear-btn="true" name="pinInoutNumber" pattern="[0-9]*" id="pinInputNumber" step="1"
            value="" style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <div class="ui-grid-a">
            <div class="ui-block-a">
              <p style="text-align: end; margin-right: 16px;">Auto-Login:</p>
            </div>
            <div class="ui-block-b">
              <select name="slider-flip-m" id="slider-flip-m" data-role="slider" data-mini="true">
                <option value="off">No</option>
                <option value="on" selected="">Yes</option>
              </select>
            </div>
          </div>
        </div>
        <div class="ui-block-a">
          <h2 id="loginUserNameDisplayText" style="text-align: center;"></h2>
        </div>
      </div>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#configPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Config</a>
        <a id="loginButton" href="#resourcesPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Login</a>
        <a href="#loginErrorPanel"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      $(document).on("pagebeforeshow", e => {
        loginUserNameDisplayText.textContent = ""
      })
      function showLoginError(text) {
        loginErrorDisplayText.textContent = text
        $("#loginErrorPanel").panel("open")
      }
      $(document).on("pageinit", e => {
        if(e.target.id === "loginPage") {
          loginButton.addEventListener("click", e => {
            e.preventDefault()
            sqlBrokerUQ(null,"QueryEmployeeByUserCode","p0=" + userCodeInputText.value,
              function(sqlResult){
                if(sqlResult.data.length) {
                  saveUserToLocalStore(sqlResult.data[0])
                  loginUserNameDisplayText.textContent = "Hello " + sqlResult.data[0].lastName + ", " + sqlResult.data[0].firstName
                  const userCode = sqlResult.data[0].USER_CODE
                  sqlBrokerUQ(null,"QueryRunningJobsForUser","p0=" + userCode,
                    function(sqlResult){
                      if(sqlResult.data && sqlResult.data.length > 0) {
                        //User has runnig job, so, show running job page
                        //Even if she has multiple running jobs we show only the first one.
                        //This application supports only-one-at-a-time running job concept
                        saveRunningJobToLocalStore(sqlResult.data[0])
                        $.mobile.changePage("#runningJobPage")      
                      } else {
                        //No running job show resources to pick one for starting operation
                        $.mobile.changePage("#resourcesPage")      
                      }                  
                    }, showLoginError,globalTimeout())
                } else {
                  showLoginError(`Invalid user code ${userCodeInputText.value}`)
                }
              }, showLoginError,globalTimeout())
            }
          )
        }
      })
    </script>
  </section>

  <!-- RESOURCES -->
  <section data-role="page" id="resourcesPage" data-theme="b">
    <div data-role="panel" data-position="right" id="resourcesErrorPanel">
      <p id="resourcesErrorDisplayText">Some Problem</p>
      <a href="#resourcesPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Resources</h1>
    </header>
    <main role="main" class="ui-content">
      <ul id="resourcesListView"
        data-role="listview" data-count-theme="b" data-filter="true" data-filter-placeholder="Search ..."
        data-inset="true">
        <li data-icon="gear"><a href="#startJobPage">Cracker Painter<span class="ui-li-count">98</span></a></li>
        <li data-icon="gear"><a href="#startJobPage">Giga Crane BX5<span class="ui-li-count">41</span></a></li>
        <li data-icon="user"><a href="#startJobPage">Packagers<span class="ui-li-count">4</span></a></li>
        <li data-icon="user"><a href="#startJobPage">MC SEtup Specialist<span class="ui-li-count">12</span></a></li>
        <li data-icon="star"><a href="#startJobPage">Red Big Hammers <span class="ui-li-count">328</span></a></li>
        <li data-icon="star"><a href="#startJobPage">Trash Can Hanger <span class="ui-li-count">62</span></a></li>
      </ul>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#loginPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Logout</a>
        <!-- <a href="#startJobPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Jobs</a> -->
        <!-- <a href="#resourcesErrorPanel" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a> -->
      </div>
    </footer>
    <script>
      function showResourcesError(text) {
        resourcesErrorDisplayText.textContent = text
          $("#resourcesErrorPanel").panel("open")
      }
      function queryAndShowResourcesAsync() {
        const userDetails = getUserDetailsFromLocalStore()
        sqlBrokerUQ(null,"QueryResourcesForUser","p0=" + userDetails.USER_CODE,
          function(sqlResult){
            if(sqlResult.data && sqlResult.data.length > 0) {
              const htmlText = sqlResult.data.reduce((a,r)=> a += `
              <li data-icon="${resIcon(r.ResType)}">
                <a href="#startJobPage" data-rescode="${r.ResCode}">${r.ResName}<span class="ui-li-count">${r.OpenJobs}</span></a>
              </li>`,"")
              $("#resourcesListView").html(htmlText).listview("refresh")
            }                  
          }, showResourcesError,globalTimeout())
      }
      $(document).on("pagebeforeshow", e => {
        if(e.target.id === "resourcesPage") {
          queryAndShowResourcesAsync() 
        }        
      })
      $(document).on("pageinit", e => {
        if(e.target.id === "resourcesPage") {
          $("#resourcesListView").click(e => {
            //e.preventDefault()
            //resourcesErrorDisplayText.textContent = e.target.dataset.rescode
            //$("#resourcesErrorPanel").panel("open")
            saveResCodeToLocalStore(e.target.dataset.rescode)
          })
        }
      })
    </script>
  </section>

  <!-- START JOB -->
  <section data-role="page" id="startJobPage" data-theme="b">
    <div data-role="panel" data-position="right" id="startJobErrorPanel">
      <p id="startJobErrorDisplayText">No jobs to start</p>
      <a href="#startJobPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Jobs</h1>
      <a href="#resourcesPage" data-icon="gear">Res</a>
    </header>
    <main role="main" class="ui-content">
      <ul id="openJobsListView"
        data-role="listview" data-filter="true" data-filter-placeholder="Search ..." data-inset="true">
        <li data-role="list-divider">10/8/2020 Morning Shift<span class="ui-li-count">2</span></li>
        <li data-icon="gear">
          <a href="#runningJobPage">
            <h2>Dry Hanging</h2><span class="ui-li-count">4500</span>
            <p><strong>Red Bike BXP 75</strong></p>
            <p class="ui-li-aside"><strong>35478-12 (6:24)</strong></p>
          </a>
        </li>
        <li data-icon="gear">
          <a href="#">
            <h2>Dry Hanging (Rework)</h2><span class="ui-li-count">23700.5</span>
            <p><strong>Boston Conference Fork</strong></p>
            <p class="ui-li-aside"><strong>35611-1 (9:18)</strong></p>     
          </a>
        </li data-icon="gear">
        <li data-role="list-divider">10/8/2020 Night Shift<span class="ui-li-count">1</span></li>
        <li data-icon="gear">
          <a href="#">
            <h2>Avery Walking</h2><span class="ui-li-count">50550</span>
            <p><strong>Dinner Tonight Kit BX 567</strong></p>
            <p class="ui-li-aside"><strong>35534-8 19:48</strong></p>
          </a>
        </li>
      </ul>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#resourcesPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Resource</a>
        <!-- <a href="#runningJobPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Start</a> -->
        <a href="#loginPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Logout</a>
        <!-- <a href="#startJobErrorPanel" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-forbidden ui-btn-b">Hmm</a> -->
      </div>
    </footer>
    <script>
      function showStartJobError(text) {
        startJobErrorDisplayText.textContent = text
        $("#startJobErrorPanel").panel("open")
      }
      function showOpenJobsToStart(data) {
        let runningDate = null
        const htmlText = data.reduce((a,r)=> {
          if(r.EffStartDate != runningDate) {
            runningDate = r.EffStartDate
            a += `
              <li data-role="list-divider">${formatDate(runningDate)}
                <span class="ui-li-count">${formatTime(r.BeginTime)}</span>
              </li>
            `    
          }
          a += `
              <li data-icon="${resIcon(r.ResType)}">
                <a href="#runningJobPage" data-docentry="${r.DocEntry}" data-linenum="${r.LineNum}">
                  <h2 data-docentry="${r.DocEntry}" data-linenum="${r.LineNum}" >${r.Name}</h2><span class="ui-li-count">${parseFloat(r.OpenQty)}</span>
                  <p><strong>${r.ProdName}</strong></p>
                  <p class="ui-li-aside"><strong>${r.DocNum}/${r.SeqNum}/${r.VisOrder} (${formatTime(r.BeginTime)})</strong></p>
                </a>
              </li>
              `
          return a
        },"")
        $("#openJobsListView").html(htmlText).listview("refresh")
      }
      function queryOpenJobsToStartForUserAndResource() {
        const userDetails = getUserDetailsFromLocalStore()
        const resCode = getResCodeFromLocalStore()
        sqlBrokerUQ(null,"QueryOpenJobsToStartForUserAndResource",`p0=${resCode}&p1=${userDetails.USER_CODE}`,
          function(sqlResult) {
            showOpenJobsToStart(sqlResult.data)
          },showStartJobError)
      }
      $(document).on("pageshow", e => {
        if(e.target.id === "startJobPage") {
          queryOpenJobsToStartForUserAndResource()
        }        
      })
      $(document).on("pagebeforeshow", e => {
        if(e.target.id === "startJobPage") {
          $("#openJobsListView").html("").listview("refresh")
        }        
      })
      $(document).on("pageinit", e => {
        if(e.target.id === "startJobPage") {
          $("#openJobsListView").click(e => {
            //Since this handler is executed non-blocking we have to prevent default navigation
            //When all are OK, manually move to the next page.
            e.preventDefault()
            let target = e.target 
            if(!target.dataset.docentry) {
              target = $(e.target).closest("a")
              if(target.length) {target = target[0]}
            }
            const op = {
              DocEntry: target.dataset.docentry,
              LineNum: target.dataset.linenum,
            }
            const ud = getUserDetailsFromLocalStore()
            //console.log(op)
            if(op.DocEntry && op.LineNum) {
              saveOperationDetailsToLocalStore(op)
              sqlBrokerUQ(null,"CanUserStartOperation",`p0=${ud.USER_CODE}&p1=${op.LineNum}&p2=${op.DocEntry}`,
                function (sqlResult) {
                  if(sqlResult.data && sqlResult.data.length > 0) {
                    console.log(`Yes, ${ud.USER_CODE} can start operation ${op.DocEntry}-${op.LineNum}`, sqlResult.data)
                    console.log("Create an activity for the start operation using BO/Activity", sqlResult.data[0])
                    const act = newActivity(null, sqlResult.data[0].DocEntry
                      ,`Operation ${sqlResult.data[0].DocEntry}-${sqlResult.data[0].LineNum} started for ${sqlResult.data[0].USERID}`
                      ,2 * 60 * 60,sqlResult.data[0].USERID,1,sqlResult.data[0].LineNum) // 1 is a user defined code for Activity Started
                    sqlBrokerPostBO(null,"Activity", act, function(boResult) {
                        //Go back to the login page, it's meaningless to go to the 
                        //running job page, when she logs in again, and if she
                        //has running job the control jumps from login to the
                        //running job page right away
                        $.mobile.changePage("#loginPage")
                    }, showStartJobError,globalTimeout())
                  } else {
                    showStartJobError(`User ${ud.USER_CODE} cannot start job ${op.DocEntry}-${op.LineNum}. Maybe the completed qty has reached planned qty.`)
                  }
                },showStartJobError,globalTimeout()
              )
            } else {
              showStartJobError("Click on the gear in the list")
            }
          })
        }
      })
    </script>
  </section>

  <!-- RUNNING JOB -->
  <section data-role="page" id="runningJobPage" data-theme="b">
    <header data-role="header">
      <h1>Running Job</h1>
    </header>
    <main role="main" class="ui-content">
      <div class="ui-grid-a">
        <div class="ui-block-a ui-body-b">
          <h2 id="operationNameDisplayText" style="text-align: center;">Dry Hanging</h2>
          <p style="text-align: center;" id="openQtyDisplayText">[4500]</p>
          <p style="text-align: center;"><strong id="productNameDisplayText">Red Bike BXP 75</strong></p>
          <p style="text-align: center;" class="ui-li-aside ui-body-c"><strong id="operationIDDisplayText">35478-12 (6:24)</strong></p>
          <p style="text-align: center;" id="resourceCodeAndNameDisplayText">Senior Technician (R300005)</p>
        </div>
        <div class="ui-block-b">
          <div class="ui-grid-solo">
            <div class="ui-block-a">
              <h2 style="text-align: center;">Started</h2>
              <h2 id="starttime" style="text-align: center;">08:05:23</h2>
            </div>
            <div class="ui-block-a ui-body-a">
              <h2 style="text-align: center;">Running</h2>
              <h2 id="runningtime" style="text-align: center;">02:15:52</h2>
            </div>
            <div class="ui-block-a">
              <p style="text-align: center;" id="routStageStatusDisplayText">Planned</p>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#loginPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Logout</a>
        <a href="#jobQuantitiesPage"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Stop</a>
        <a href="#" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      $(document).on("pagebeforeshow", e => {
        if(e.target.id === "runningJobPage") {
          const job = getRunningJobFromLocalStore()
          resourceCodeAndNameDisplayText.textContent = `${job.ItemName} (${job.ItemCode})`
          routStageStatusDisplayText.textContent = (job.Status === "I" ? "In Progress" : (job.Status === "C" ? "Completed" : "Planned"))
          operationNameDisplayText.textContent = job.RSName ? job.RSName : job.ItemName
          openQtyDisplayText.textContent = `[ ${parseInt(job.OpenQty)} ]`
          productNameDisplayText.textContent = job.ProdName
          operationIDDisplayText.textContent = `${job.DocNum} / ${job.SeqNum} / ${job.VisOrder}`
          starttime.textContent = formatTime(job.BeginTime)
          const runningMinutes = minuteDiff(sapDTToDate(job.Recontact,job.BeginTime),new Date())
          runningtime.textContent = formatMinDiff(runningMinutes) + ` (${(runningMinutes/60).toFixed(2)}h)`
        }
      })
      /*
      RSName: "Route Stage 1"
      Action: "T" BeginTime: "1833" Comments: "Don't hesitate to do the job perfectly" ClgCode: "16"
      DocEntry: "155" DocNum: "155" ItemCode: "R300005" ItemName: "Assembly Machine"
      OpenQty: "50.000000" ProdName: "32GB Memory Server" Recontact: "5/7/2020 12:00:00 AM"
      SeqNum: "" StageId: "" Status: "P" USERID: "22" USER_CODE: "maria"
      */
    </script>
  </section>

  <!-- JOB QUANTITIES -->
  <section data-role="page" id="jobQuantitiesPage" data-theme="b">
    <div data-role="panel" data-position="right" id="jobQuantitiesErrorPanel">
      <h2 id="jobQuantitiesErrorDisplayText">Invalid rejected quantity</h2>
      <a href="#jobQuantitiesPage" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back"
        data-rel="close">Close</a>
    </div>
    <header data-role="header">
      <h1>Quantities</h1>
    </header>
    <main role="main" class="ui-content">
      <div class="ui-grid-a">
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Compl Qty (<span id="completedQtyDisplayText">9999</span>)</p>
        </div>
        <div class="ui-block-b">
          <input placeholder="56000" type="number" data-clear-btn="true" id="completedQtyInputNumber" step="1" value=""
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Rewrk Qty (<span id="reworkQtyDisplayText">9999</span>)</p>
        </div>
        <div class="ui-block-b">
          <input placeholder="100" type="number" data-clear-btn="true" id="reworkQtyInputNumber" step="1" value=""
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Rejctd Qty (<span id="rejectedQtyDisplayText">9999</span>)</p>
        </div>
        <div class="ui-block-b">
          <input placeholder="0" type="number" id="rejectedQtyInputNumber" step="1" value=""
          data-clear-btn="true" style="text-align: center;"> 
        </div>
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Hours</p>
        </div>
        <div class="ui-block-b">
          <input placeholder="0" type="number" id="hoursInputNumber" step="1" value=""
          readonly="true" style="text-align: center;"> 
        </div>
      </div>
    </main>
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#runningJobPage" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Cancel</a>
        <a id="jobQuantitiesDoneButton" href="#resourcesPage" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-home ui-btn-b">Done</a>
        <a href="#jobQuantitiesErrorPanel"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      function showJobQuantitiesError(text) {
        jobQuantitiesErrorDisplayText.textContent = text
        $("#jobQuantitiesErrorPanel").panel("open")
      }
      $(document).on("pageinit", e => {
        if(e.target.id === "jobQuantitiesPage") {
          jobQuantitiesDoneButton.addEventListener("click", e => {
            e.preventDefault()
            // console.log(e.target.id)
            const po = getProductionOrderFromLocalStore()
            const job = getRunningJobFromLocalStore()
            const wor1 = po.BOM.BO.WOR1.row.find(r => r.LineNum === job.U_LineNum)
            // [[[ STEP 1 - Issue Resource Minutes for Production Order Component Line ]]]
            // SQL Broker's new Multi-Request service is going to be used, so let's bult a MR object
            const runningMinutes = minuteDiff(sapDTToDate(job.Recontact,job.BeginTime),new Date())
            const ifpReq = newIssueForProd(null, `${job.DocNum},${job.VisOrder}`
              , ` Stop Job for ${job.DocNum}-${job.U_LineNum}`, `Issue Resource Consumption for Production from JobWatch`
              , job.DocEntry, job.U_LineNum, runningMinutes/60) // For this project resource issues are in hours
            const mReq = newMR(null)//Default profile is used
            addBoReqToMR(mReq,"POST","InventoryGenExit",ifpReq) //TODO: UNCOMMENT ME
            // [[[ STEP 2 - Update Quantities in Production Order Line ]]]
            const completedQty = getFloat(completedQtyInputNumber.value) 
            const reworkQty = getFloat(reworkQtyInputNumber.value)
            const rejectedQty = getFloat(rejectedQtyInputNumber.value)
            if(completedQty + reworkQty + rejectedQty) {
              //Save the already reported quantities from WOR1 line since the lines will be truncated in the next step
              const U_CompletedQty = getFloat(wor1.U_CompletedQty) 
              const U_ReworkQty =  getFloat(wor1.U_ReworkQty)
              const U_RejectedQty = getFloat(wor1.U_RejectedQty)
              //WARNING! Save data into local variables before they will be truncated
              deleteAllPropsExcept(po.BOM.BO.OWOR.row,"DocEntry") // For update DocEntry is enough
              po.BOM.BO.WOR1.row.forEach((r,i) => 
                deleteAllPropsExcept(r,"DocEntry,LineNum")
              ) // DocEntry, Line num are for identifying the WOR1 line, the three user fields to be updated
              wor1.U_CompletedQty = U_CompletedQty +  completedQty //Original plus the completed qty entered now 
              wor1.U_ReworkQty =  U_ReworkQty + reworkQty
              wor1.U_RejectedQty = U_RejectedQty + rejectedQty
              console.log(wor1)
              //Clean-up JSON tree of the gigantic Production Order tree to prevent unwanted behavior
              //All fields will be removed except the ones defined in the list
              addBoReqToMR(mReq,"PUT","ProductionOrders",{bo:po},job.DocEntry)//TODO: UNCOMMENT ME
            }
            // [[[ STEP 3 - Update Start Job Task Activity To Complete the Job ]]]
            // Query Activity before updating
            const actToUpdate = makeActivityObjectForUpdate(null, job.ClgCode, runningMinutes * 60, "-3") //Close
            addBoReqToMR(mReq,"PUT","Activity",actToUpdate,job.ClgCode)//TODO: UNCOMMENT ME
            console.log("Multi-Request",mReq)
            sqlBrokerMultiReq(null,mReq, function(mrResult){
                console.log("Running Job Stopped Successfully", mrResult)
                sqlBrokerUQ(null,"UpdateStageForProductionOrderLine",`p0=${job.DocEntry}&p1=${job.U_LineNum}`,
                function(sqlResult) {
                  console.log("Update Status",sqlResult.data[0])
                  $.mobile.changePage("#loginPage")
                }, showJobQuantitiesError,globalTimeout())
              }, showJobQuantitiesError,globalTimeout() * 2)
          })
        }
      })
      $(document).on("pageshow", e => {
        if(e.target.id === "jobQuantitiesPage") {
          //Load production order BO to get quantities and other useful information
          showLoadingIndicator()
          const job = getRunningJobFromLocalStore()
          sqlBrokerGetBO(null,"ProductionOrders",job.DocEntry,
          function (boResult) {
            // console.log(boResult.bo)
            //Find job row in production order BO
            const wor1 = boResult.bo.BOM.BO.WOR1.row.find(r => r.LineNum === job.U_LineNum)
            // console.log(wor1)
            const plannedQty = getFloat(boResult.bo.BOM.BO.OWOR.row.PlannedQty)
            const cmpltQty = getFloat(boResult.bo.BOM.BO.OWOR.row.CmpltQty)
            const U_CompletedQty = getFloat(wor1.U_CompletedQty)
            const openQty = plannedQty -  Math.max(cmpltQty,U_CompletedQty) 
            // console.log(openQty)
            completedQtyInputNumber.value = openQty
            rejectedQtyInputNumber.value = null
            reworkQtyInputNumber.value = null
            completedQtyDisplayText.textContent = U_CompletedQty
            reworkQtyDisplayText.textContent = getFloat(wor1.U_ReworkQty)
            rejectedQtyDisplayText.textContent = getFloat(wor1.U_RejectedQty)
            hoursInputNumber.value = (minuteDiff(sapDTToDate(job.Recontact,job.BeginTime),new Date())/60).toFixed(2)
            // const U_ReworkQty = parseFloat(wor1.U_ReworkQty)
            // console.log(wor1.U_CompletedQty, wor1.U_ReworkQty, parseFloat(wor1.U_RejectedQty))
            saveProductionOrderToLocalStore(boResult.bo)
          }, showJobQuantitiesError,globalTimeout())
        }
      })
    </script>
  </section>

</body>

</html>