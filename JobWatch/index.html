<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./jquery-mobile-theme-073121-0/themes/t11jobswatch.css">
  <link rel="stylesheet" href="./jquery-mobile-theme-073121-0/themes/jquery.mobile.icons.min.css">
  <!-- <link rel="stylesheet" href="./commadelimited-jQuery-Mobile-Icon-Pack/dist/jqm-icon-pack-fa.css" /> -->
  <!-- <link rel="stylesheet" href="./jquery/jquery.mobile-1.4.5.css"> -->
  <link rel="stylesheet" href="./jquery/jquery.mobile.structure-1.4.5.css">
  <link rel="shortcut icon" href="./jquery/demos/favicon.ico">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
  <script src="./jquery/demos/js/jquery.js"></script>
  <!-- <script src="./jquery/demos/_assets/js/index.js"></script> -->
  <script>
    $(document).one("mobileinit", function () {
      $.mobile.defaultPageTransition = "slide"
    })
  </script>
  <script src="./jquery/jquery.mobile-1.4.5.min.js"></script>
  <!-- <script src="./js/main.js"></script> -->
  <!-- <script src="./js/bundle.js"></script> -->
  <style>
    /* Adjust the vertical three dots of this icon centered */
    .ui-icon-ellipsis-v:after {
      background-image: url("commadelimited-jQuery-Mobile-Icon-Pack/dist/png/ellipsis-v.png");
      background-repeat: no-repeat;
      /* background-position: 9px 3px; */
      background-position-x: 9px;
    }
  </style>
  <title>Job Watch</title>
</head>

<body>
  <!-- CONFIG -->
  <section data-role="page" id="config" data-theme="b">
    <div data-role="panel" data-position="right" id="config_error">
      <!-- panel content goes here -->
      <h2 id="config_error_text">Cannot Connect to Server</h2>
      <a href="#config" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div><!-- /panel -->
    <header data-role="header">
      <h1>Config</h1>
    </header>
    <main class="ui-content">
      <!-- contents -->
      <div class="ui-grid-solo">
        <div class="ui-block-a">
          <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true" style="text-align: center;">
            <input type="radio" name="http" id="httpOption" value="http" checked="checked">
            <label for="httpOption">HTTP</label>
            <input type="radio" name="http" id="httpsOption" value="https">
            <label for="httpsOption">HTTPS</label>
          </fieldset>
        </div>
        <div class="ui-block-a">
          <input id="hostName" placeholder="julika.villo.io" type="text" data-clear-btn="true" name="hostName"
            value="MIKISURFACE" style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <div class="ui-grid-a">
            <div class="ui-block-a">
              <input id="serviceName" placeholder="api" type="text" data-clear-btn="true" name="serviceName"
                value="t11sqlbroker" style="text-align: center;">
            </div>
            <div class="ui-block-b">
              <input id="portNumber" placeholder="99999" type="number" step="1" data-clear-btn="true" name="portNumber"
                pattern="[0-9]*" value="80" style="text-align: center;">
            </div>
          </div>
        </div>
      </div>
    </main><!-- /content -->
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Exit</a>
        <a id="doneButton" href="#login" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-home ui-btn-b">Done</a>
        <a href="#" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      //console.log("Reloaded on " + Date.now())
      //pageinit event is only JQuery event
      $(document).one("pageinit", async e => {
        if(e.target.id === "config") {
          doneButton.addEventListener("click", async e => {
            e.preventDefault()
            saveServiceURLToLocalStore()
            try {
              let response = await SQLBroker("select top 1 ItemCode from OITM")
              //console.log(response.data[0].ItemCode)
              //config_error_text.textContent = response.data[0].ItemCode
              $.mobile.changePage("#login")
            } catch(error) {
                config_error_text.textContent = error.responseJSON.errorText
                $("#config_error").panel("open")
                console.log(error);
              }
            }
          )
        }
      })
      function showLoadingIndicator(text = "Loading ...") {
        $.mobile.loading("show", {text, textVisible:true,theme:"b"})
      }
      function hideLoadingIndicator(text = "Loading ...") {
        $.mobile.loading("hide")
      }
      //This is much better, since then interactive programming is a lot more simpler since 
      //the status of the app is saved in the local store
      function saveServiceURLToLocalStore() {
        let url = (httpOption.checked ? "http" : "https") + "://"
        url += hostName.value + ":" + portNumber.value + "/"
        url += serviceName.value + "/api/"
        console.log(url)
        localStorage.setItem("sqlbroker",url)
      }
      function sql() { return localStorage.getItem("sqlbroker") + "SQL"} 
      function bo() { return localStorage.getItem("sqlbroker") + "BO"} 
      async function SQLBroker(SQL) {
        try {
          showLoadingIndicator()
          return await $.ajax({url:sql(),type:"POST",dataType:"json",
              contentType:"application/json",processData:false,
              data:JSON.stringify({SQL})})
        } finally {
          hideLoadingIndicator()
        }
      }
      async function sleepAsync(ms){
        return new Promise(resolve => setTimeout(resolve,ms))
      }
</script>
  </section><!-- /page -->

  <!-- LOGIN -->
  <section data-role="page" id="login" data-theme="b">
    <div data-role="panel" data-position="right" id="login_error">
      <!-- panel content goes here -->
      <h2 id="login_error_text">Invalid user name or PIN</h2>
      <a href="#login" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div><!-- /panel -->
    <header data-role="header">
      <h1>Login</h1>
    </header><!-- /header -->
    <main role="main" class="ui-content">
      <div class="ui-grid-solo">
        <div class="ui-block-a">
          <input placeholder="user" type="text" data-clear-btn="true" name="user" id="user" value="merlina"
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <input placeholder="1234" type="number" data-clear-btn="true" name="pin" pattern="[0-9]*" id="pin" step="1"
            value="" style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <div class="ui-grid-a">
            <div class="ui-block-a">
              <p style="text-align: end; margin-right: 16px;">Auto-Login:</p>
            </div>
            <div class="ui-block-b">
              <select name="slider-flip-m" id="slider-flip-m" data-role="slider" data-mini="true">
                <option value="off">No</option>
                <option value="on" selected="">Yes</option>
              </select>
            </div>
          </div>
        </div>
        <div class="ui-block-a">
          <h2 id="loginUserName" style="text-align: center;"></h2>
        </div>
      </div>
    </main><!-- /content -->
    <footer data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#config" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Config</a>
        <a id="loginButton" href="#resources" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Login</a>
        <a href="#login_error"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </footer>
    <script>
      $(document).on("pageinit", async e => {
        if(e.target.id === "login") {
          loginButton.addEventListener("click", async e => {
            e.preventDefault()
            //saveUserToLocalStore()
            try {
              let response = await SQLBroker(
                `select Code,e.userId,lastName,firstName 
                from OHEM e left outer join OUSR u on e.userId = u.USERID  
                where u.USER_CODE = '${user.value}' 
                -- or Code = '${user.value}'`)
              if(response.data.length) {
                loginUserName.textContent = "Hello " + response.data[0].lastName + ", " + response.data[0].firstName 
                await sleepAsync(500)
                $.mobile.changePage("#resources")
              } else {
                login_error_text.textContent = `Invalid user code ${user.value}`
                $("#login_error").panel("open")
              }
            } catch(error) {
                login_error_text.textContent = error.responseJSON.errorText
                $("#login_error").panel("open")
                // console.log(error);
              }
            }
          )
        }
      })

    </script>
  </section>

  <!-- RESOURCES -->
  <div data-role="page" id="resources" data-theme="b">
    <div data-role="header">
      <h1>Resources</h1>
    </div>
    <div role="main" class="ui-content">
      <ul data-role="listview" data-count-theme="b" data-filter="true" data-filter-placeholder="Search ..."
        data-inset="true">
        <li data-icon="gear"><a href="#">Cracker Painter<span class="ui-li-count">98</span></a></li>
        <li data-icon="gear"><a href="#">Giga Crane BX5<span class="ui-li-count">41</span></a></li>
        <li data-icon="user"><a href="#">Packagers<span class="ui-li-count">4</span></a></li>
        <li data-icon="user"><a href="#">MC SEtup Specialist<span class="ui-li-count">12</span></a></li>
        <li data-icon="star"><a href="#">Red Big Hammers <span class="ui-li-count">328</span></a></li>
        <li data-icon="star"><a href="#">Trash Can Hanger <span class="ui-li-count">62</span></a></li>
      </ul>
    </div>
    <div data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#login" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Logout</a>
        <a href="#startjob" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Jobs</a>
        <a href="#login_error"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </div>
  </div>

  <!-- START JOB -->
  <div data-role="page" id="startjob" data-theme="b">
    <div data-role="panel" data-position="right" id="startjob_error">
      <h2>No jobs to start</h2>
      <a href="#startjob" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Close</a>
    </div><!-- /panel -->
    <div data-role="header">
      <h1>Jobs</h1>
      <a href="#resource" data-icon="gear">Res</a>
    </div>
    <div role="main" class="ui-content">
      <ul data-role="listview" data-filter="true" data-filter-placeholder="Search ..." data-inset="true">
        <li data-role="list-divider">10/8/2020 Morning Shift<span class="ui-li-count">2</span></li>
        <li data-icon="gear">
          <a href="#runningjob">
            <h2>Dry Hanging</h2><span class="ui-li-count">4500</span>
            <p><strong>Red Bike BXP 75</strong></p>
            <p class="ui-li-aside"><strong>35478-12 (6:24)</strong></p>
          </a>
        </li>
        <li data-icon="gear">
          <a href="#">
            <h2>Dry Hanging (Rework)</h2><span class="ui-li-count">23700.5</span>
            <p><strong>Boston Conference Fork</strong></p>
            <p class="ui-li-aside"><strong>35611-1 (9:18)</strong></p>     
          </a>
        </li data-icon="gear">
        <li data-role="list-divider">10/8/2020 Night Shift<span class="ui-li-count">1</span></li>
        <li data-icon="gear">
          <a href="#">
            <h2>Avery Walking</h2><span class="ui-li-count">50550</span>
            <p><strong>Dinner Tonight Kit BX 567</strong></p>
            <p class="ui-li-aside"><strong>35534-8 19:48</strong></p>
          </a>
        </li>
      </ul>
    </div>
    <div data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#resources" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Resource</a>
        <a href="#runningjob" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Start</a>
        <a href="#login" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Logout</a>
        <a href="#startjob_error"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-forbidden ui-btn-b">Hmm</a>
      </div>
    </div>
  </div>

  <!-- RUNNING JOB -->
  <div data-role="page" id="runningjob" data-theme="b">
    <div data-role="header">
      <h1>Running Job</h1>
    </div>
    <div role="main" class="ui-content">
      <div class="ui-grid-a">
        <div class="ui-block-a">
          <h2>Dry Hanging</h2><strong>[4500]</strong>
          <p><strong>Red Bike BXP 75</strong></p>
          <p class="ui-li-aside"><strong>35478-12 (6:24)</strong></p>
        </div>
        <div class="ui-block-b">
          <div class="ui-grid-solo">
            <div class="ui-block-a">
              <h2>Started</h2>
              <h2 id="starttime">08:05:23</h2>
            </div>
            <div class="ui-block-a">
              <h2>Running</h2>
              <h2 id="runningtime">02:15:52</h2>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#login" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-user ui-btn-b">Logout</a>
        <a href="#completedquantities"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-r ui-btn-b">Stop</a>
        <a href="#" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </div>
  </div>

  <!-- COMPLETED QUANTITIES -->
  <div data-role="page" id="completedquantities" data-theme="b">
    <div data-role="panel" data-position="right" id="completedquantities_error">
      <h2>Invalid rejected quantity</h2>
      <a href="#completedquantities" class="ui-btn ui-corner-all ui-btn-icon-left ui-icon-back"
        data-rel="close">Close</a>
    </div><!-- /panel -->
    <div data-role="header">
      <!-- /header -->
      <h1>Quantities</h1>
    </div>
    <div role="main" class="ui-content">
      <div class="ui-grid-a">
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Completed Qty:</p>
        </div>
        <div class="ui-block-b">
          <input placeholder="56000" type="number" data-clear-btn="true" id="completedqty" step="1" value=""
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Rework Qty:</p>
        </div>
        <div class="ui-block-b">
          <input placeholder="100" type="number" data-clear-btn="true" id="reworkqty" step="1" value=""
            style="text-align: center;">
        </div>
        <div class="ui-block-a">
          <p style="text-align: right; margin-right: 16px;">Rejected Qty:</p>
        </div>
        <div class="ui-block-b">
          <div class="ui-grid-a">
            <div class="ui-block-a">
              <input placeholder="0" type="number" id="rejectedqty" step="1" value=""
                style="text-align: center;"> <!-- data-clear-btn="true" -->
            </div>
            <div class="ui-block-b">
              <input placeholder="0" type="number" data-clear-btn="true" id="rejqtydec" step="1" value=""
                style="text-align: center;">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div data-role="footer" data-position="fixed">
      <div data-role="controlgroup" data-type="horizontal" data-mini="false" style="text-align: center;">
        <a href="#runningjob" data-direction="reverse"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-arrow-l ui-btn-b">Cancel</a>
        <a href="#resources" class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-home ui-btn-b">Done</a>
        <a href="#completedquantities_error"
          class="ui-shadow ui-btn ui-corner-all ui-btn-icon-left ui-icon-ellipsis-v ui-btn-b">More</a>
      </div>
    </div><!-- /footer -->
  </div><!-- /page -->

</body>

</html>